@page "/streaks"
@using Journal_Application.Services
@using Journal_Application.Models
@inject JournalDatabase Database

<h3>🔥 Journal Streak Tracking</h3>

<div class="streak-cards">
    <div class="card">
        <h4>Current Streak</h4>
        <p>@CurrentStreak days</p>
    </div>

    <div class="card">
        <h4>Longest Streak</h4>
        <p>@LongestStreak days</p>
    </div>

    <div class="card">
        <h4>Missed Days</h4>
        <p>@MissedDays days</p>
    </div>
</div>

<style>
    .streak-cards {
        display: flex;
        gap: 20px;
        margin-top: 20px;
        flex-wrap: wrap;
    }

    .card {
        background: #eef2ff;
        padding: 20px;
        border-radius: 16px;
        width: 200px;
        text-align: center;
        box-shadow: 0 6px 16px rgba(0,0,0,0.08);
    }

    .card h4 {
        margin-bottom: 10px;
        color: #3730a3;
    }

    .card p {
        font-size: 26px;
        font-weight: bold;
        color: #1e293b;
    }
</style>

@code {

    private int CurrentStreak;
    private int LongestStreak;
    private int MissedDays;

    protected override async Task OnInitializedAsync()
    {
        var entries = await Database.GetAllEntriesAsync();

        var dates = entries
            .Select(e => DateTime.Parse(e.DateKey))
            .Distinct()
            .OrderBy(d => d)
            .ToList();

        if (!dates.Any())
            return;

        // Calculate streaks
        int tempStreak = 1;
        LongestStreak = 1;

        for (int i = 1; i < dates.Count; i++)
        {
            if ((dates[i] - dates[i - 1]).Days == 1)
            {
                tempStreak++;
                LongestStreak = Math.Max(LongestStreak, tempStreak);
            }
            else
            {
                tempStreak = 1;
            }
        }

        // Current streak (from today backwards)
        CurrentStreak = 0;
        var today = DateTime.Today;

        while (dates.Contains(today))
        {
            CurrentStreak++;
            today = today.AddDays(-1);
        }

        // Missed days
        var totalDays = (dates.Last() - dates.First()).Days + 1;
        MissedDays = totalDays - dates.Count;
    }
}

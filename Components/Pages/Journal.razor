@page "/journal"
@using System.Text.RegularExpressions
@using Journal_Application.Models
@using Journal_Application.Services
@inject JournalDatabase Database
@inject NavigationManager Nav

<style>
    /* ===== Page Wrapper ===== */
    .journal-wrapper {
        max-width: 900px;
        margin: 30px auto;
        padding: 25px;
        border-radius: 20px;
        background: linear-gradient(135deg, #eef2ff, #f8fafc);
    }

    h3 {
        text-align: center;
        font-weight: 700;
        margin-bottom: 25px;
        color: #1e293b;
    }

    label {
        margin-top: 18px;
        display: block;
        font-size: 14px;
        font-weight: 600;
        text-transform: uppercase;
        opacity: 0.7;
    }

    input, textarea, select {
        width: 100%;
        padding: 14px;
        margin-top: 6px;
        border-radius: 14px;
        border: none;
        background: white;
        box-shadow: inset 0 0 0 1px #e5e7eb;
        font-size: 15px;
    }.editor-toolbar {
        display: flex;
        gap: 10px;
        margin-top: 16px;
        flex-wrap: wrap;
    }

    .editor-toolbar button {
        padding: 10px 16px;
        border-radius: 999px;
        border: none;
        background: #e0e7ff;
        color: #3730a3;
        font-weight: 600;
        cursor: pointer;
    } textarea {
        min-height: 250px;     margin-top: 12px;
    }

    .save-btn {
        width: 100%;
        margin-top: 30px;
        padding: 16px;
        border-radius: 16px;
        border: none;
        background: linear-gradient(135deg, #6366f1, #4f46e5);
        color: white;
        font-size: 17px;
        font-weight: 600;
        cursor: pointer;}
 .markdown-preview {
        margin-top: 25px;
        padding: 20px;
        border-radius: 16px;
        background: white;
        box-shadow: 0 10px 25px rgba(0,0,0,0.08);  }
</style>

<div class="journal-wrapper">

    <!-- ✅ NEW BUTTON (THIS IS THE KEY) -->
    <button style="margin-bottom:20px; padding:12px 20px; border-radius:10px;"
            @onclick="GoToEntries">
        📄 View Past Entries
    </button>

    <h3>Today's Journal Entry – @DateTime.Today.ToLongDateString()</h3>

    <label>Title</label>
    <input @bind="Title" />

    <label>Primary Mood *</label>
    <select @bind="PrimaryMood">
        <option value="">-- Select Primary Mood --</option> <option>Happy</option>
        <option>Calm</option>  <option>Stressed</option>
    </select>
    <label>Journal Content</label>
 <div class="editor-toolbar">
        <button @onclick="AddBold">Bold</button>
        <button @onclick="AddItalic">Italic</button>
        <button @onclick="AddHeading">Heading</button>
        <button @onclick="AddList">List</button>
    </div>
    <textarea @bind="MarkdownContent"></textarea>

    <button class="save-btn" @onclick="SaveEntry">
        Save Journal Entry
    </button>
 <h4 style="margin-top:30px;">Live Preview</h4>
    <div class="markdown-preview">
        @((MarkupString)RenderMarkdown(MarkdownContent))
    </div></div>

@code {

    // Journal Data
    string Title = "";
    string MarkdownContent = "";
    string PrimaryMood = "";
    DateTime CreatedAt = DateTime.Now;
    DateTime UpdatedAt = DateTime.Now;

    string TodayKey => DateTime.Today.ToString("yyyy-MM-dd");

    protected override async Task OnInitializedAsync()
    {
        var entry = await Database.GetEntryAsync(TodayKey);
        if (entry != null)
        {
            Title = entry.Title;
            MarkdownContent = entry.Content;
            PrimaryMood = entry.PrimaryMood;            CreatedAt = entry.CreatedAt;
            UpdatedAt = entry.UpdatedAt;
        }}

    async Task SaveEntry()
    {        var entry = new JournalEntry
        {
            DateKey = TodayKey,
            Title = Title,
            Content = MarkdownContent,
            PrimaryMood = PrimaryMood,           CreatedAt = CreatedAt,
            UpdatedAt = DateTime.Now
        };

        await Database.SaveEntryAsync(entry);    }

    // ✅ THIS METHOD MAKES PAST ENTRIES OPEN
    void GoToEntries()
    {
        Nav.NavigateTo("/entries");
    }

    void AddBold() => MarkdownContent += "**bold**";
    void AddItalic() => MarkdownContent += "*italic*";
    void AddHeading() => MarkdownContent += "\n# Heading";
    void AddList() => MarkdownContent += "\n- Item";

    string RenderMarkdown(string text)
    {
        if (string.IsNullOrWhiteSpace(text))
            return "<i>Nothing written yet...</i>";

        var html = text;
        html = Regex.Replace(html, @"\*\*(.*?)\*\*", "<b>$1</b>");
        html = Regex.Replace(html, @"\*(.*?)\*", "<i>$1</i>");
        html = html.Replace("\n", "<br>");       return html;
    }}